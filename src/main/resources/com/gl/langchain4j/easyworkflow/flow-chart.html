<html>
<!-- generated by https://github.com/gregory-ledenev/LangChain4j-EasyWorkflow -->
<head>
    <meta charset="UTF-8">
    <title>{{title}}</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            display: flex;
            height: 100vh;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        #diagram-container {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }
        #diagram-header {
            padding: 10px;
            border-bottom: 1px solid #e1e4e8;
            background-color: #f6f8fa; /* Match container background */
            position: sticky;
            top: 0;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #diagram-header h2 {
            margin: 0;
            font-size: 16px;
        }
        #view-switcher {
            display: flex;
            border: 1px solid #d1d5da;
            border-radius: 6px;
            overflow: hidden;
        }
        #view-switcher button {
            padding: 5px 12px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 14px;
            color: #24292e;
        }
        #view-switcher button.active {
            background-color: #adbfd2;
            color: white;
            cursor: default;
        }
        #diagram-footer {
            padding: 4px;
            border-top: 1px solid #e1e4e8;
            background-color: #f6f8fa;
            text-align: center;
            font-size: 12px;
            color: #586069;
            position: sticky;
            bottom: 0;
            z-index: 1;
        }
        #diagram-content {
            padding: 10px;
            flex-grow: 1;
        }
        #summary-content {
            padding: 20px;
            flex-grow: 1;
            display: none; /* Hidden by default */
        }
        #inspector-container {
            flex: 0 0 30%;
            border-left: 1px solid #e1e4e8;
            background-color: #f6f8fa;
            color: #24292e;
            display: none; /* Initially hidden */
            flex-direction: column;
            overflow: hidden; /* Let children handle scrolling */
        }
        #inspector-header {
            padding: 10px;
            border-bottom: 1px solid #e1e4e8;
            background-color: #f6f8fa; /* Match container background */
            position: sticky;
            top: 0;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #inspector-header h2 {
            margin: 0;
            font-size: 16px;
        }
        .subheader {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 12px;
            color: #586069;
            margin-top: 4px;
            word-wrap: break-word;
        }
        #inspector-content {
            overflow-y: auto;
            flex-grow: 1;
            padding: 10px;
        }
        #inspector-nav button {
            position: relative;
            cursor: pointer;
            padding: 8px 12px;
            font-size: 16px;
            border: none;
            background: #f0f0f0;
            margin: 0 2px;
        }

        #inspector-nav button::after {
            content: attr(title);
            position: absolute;
            top: calc(100% + 5px); /* Adjusted to move tooltip lower (5px gap) */
            left: 50%;
            transform: translateX(-50%);
            background: #ffffe6;
            color: black;
            padding: 5px 10px;
            border: 1px solid darkgray;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 10;
        }

        #inspector-nav button:hover::after {
            opacity: 1;
            visibility: visible;
        }
        .json-tree {
            list-style-type: none;
            padding-left: 0;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 13px;
        }
        .json-tree li {
            display: flex;
            align-items: flex-start; /* Vertically align toggler and content */
            margin-bottom: 5px;
        }
        .json-tree .toggler {
            flex-shrink: 0;
            cursor: pointer;
            user-select: none;
            margin-right: 8px;
            padding-top: 1px;
        }
        .json-tree .toggler svg {
            transition: transform 0.15s ease-in-out;
            display: block; /* Remove extra space below SVG */
        }
        .json-tree .toggler.open svg {
            transform: rotate(45deg); /* Rotate + to x */
        }
        .json-tree .toggler:hover svg {
            opacity: 0.7;
        }
        .json-tree .content {
            flex-grow: 1;
        }
        .json-tree .nested {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }
        .json-tree .nested.open {
            max-height: 1000px; /* A large enough value to allow content to show */
        }
        .item-count {
            color: #586069;
            margin-left: 6px;
            font-style: italic;
        }
        .item-count.hidden {
            display: none;
        }
        .json-key { color: #005cc5; }
        .json-string { color: #032f62; }
        .json-number { color: #e36209; }
        .json-boolean { color: #d73a49; }
        .json-null { color: #6a737d; }

        #inspector-nav {
            display: flex;
        }
        #inspector-nav button {
            background-color: #f6f8fa;
            border: 1px solid #d1d5da;
            border-radius: 6px;
            padding: 3px 10px;
            font-size: 14px;
            cursor: pointer;
            width: 26px; /* Fixed width */
            height: 26px; /* Fixed height */
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #inspector-nav button:disabled {
            opacity: 0.5;
            cursor: default;
        }
    </style>
</head>
<body>
<div id="diagram-container">
    <div id="diagram-header">
        <div>
            <h2>{{title}}</h2>
            <div class="subheader">{{subTitle}}</div>
        </div>
        <div id="view-switcher">
            <button id="diagram-view-btn" class="active">Diagram</button>
            <button id="summary-view-btn">Summary</button>
        </div>
    </div>
    <div id="diagram-content">
        <div class="mermaid"></div>
    </div>
    <div id="summary-content">
        <!-- Markdown summary will be rendered here -->
    </div>
    <div id="diagram-footer">
        Generated by <a href="https://github.com/gregory-ledenev/LangChain4j-EasyWorkflow">EasyWorkflow</a> for <a href="https://github.com/langchain4j/langchain4j">LangChain4j</a>
    </div>
</div>
<div id="inspector-container">
    <div id="inspector-header">
        <div>
            <h2>Inspector</h2>
            <div id="inspector-node-id" class="subheader"></div>
        </div>
        <div id="inspector-nav">
            <button id="start-node" title="Start Node">&#x2912;</button>
            <button id="prev-node" title="Previous Node">&#x2191;</button>
            <button id="next-node" title="Next Node">&#x2193;</button>
            <button id="end-node" title="End Node">&#x2913;</button>
        </div>
    </div>
    <div id="inspector-content"></div>
</div>

<script>
    const nodeData = {{nodeData}};
    const nodeNames = {{nodeNames}};
    const completedNodes = {{completedNodes}};

    const workflowSummaryMarkdown = `{{workflowSummaryMarkdown}}`;

    let currentNodeIndex = -1;

    function createTogglerIcon() {
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, "svg");
        svg.setAttribute("width", "13");
        svg.setAttribute("height", "13");
        svg.setAttribute("viewBox", "0 0 13 13");

        const path = document.createElementNS(svgNS, "path");
        path.setAttribute("d", "M 3 6.5 H 10 M 6.5 3 V 10");
        path.setAttribute("stroke", "#586069");
        path.setAttribute("stroke-width", "1.5");
        path.setAttribute("fill", "none");
        svg.appendChild(path);

        return svg;
    }

    function renderJsonTree(data, isRoot = false) {
        const tree = document.createElement('ul');
        tree.className = 'json-tree';

        for (const [key, value] of Object.entries(data)) {
            const li = document.createElement('li');

            if (typeof value === 'object' && value !== null) {
                const toggler = document.createElement('div');
                toggler.className = 'toggler';
                toggler.appendChild(createTogglerIcon());
                li.appendChild(toggler);

                const content = document.createElement('div');
                content.className = 'content';

                const keySpan = document.createElement('span');
                keySpan.className = 'json-key';
                keySpan.textContent = key + ': ';
                content.appendChild(keySpan);

                const count = Object.keys(value).length;
                const itemText = count === 1 ? '1 item' : `${count} items`;
                const brace = Array.isArray(value) ? '[]' : '{}';
                const itemCountSpan = document.createElement('span');
                itemCountSpan.className = 'item-count';
                itemCountSpan.textContent = `${brace[0]}...${brace[1]} (${itemText})`;
                content.appendChild(itemCountSpan);

                const nestedTree = renderJsonTree(value, false);
                nestedTree.classList.add('nested');
                content.appendChild(nestedTree);
                li.appendChild(content);

                if (isRoot) {
                    toggler.classList.add('open');
                    nestedTree.classList.add('open');
                    itemCountSpan.classList.add('hidden');
                }

                toggler.addEventListener('click', function() {
                    toggler.classList.toggle('open');
                    nestedTree.classList.toggle('open');
                    itemCountSpan.classList.toggle('hidden');
                });
            } else {
                li.style.paddingLeft = '21px';
                const content = document.createElement('div');
                content.className = 'content';

                const keySpan = document.createElement('span');
                keySpan.className = 'json-key';
                keySpan.textContent = key + ': ';
                content.appendChild(keySpan);

                const valueSpan = document.createElement('span');
                let cls = 'json-string';
                let text = value;
                if (typeof value === 'string') {
                    text = `"${value}"`;
                } else if (typeof value === 'number') {
                    cls = 'json-number';
                } else if (typeof value === 'boolean') {
                    cls = 'json-boolean';
                } else if (value === null) {
                    cls = 'json-null';
                    text = 'null';
                }
                valueSpan.className = cls;
                valueSpan.textContent = text;
                content.appendChild(valueSpan);
                li.appendChild(content);
            }
            tree.appendChild(li);
        }
        return tree;
    }

    window.showInspector = function(nodeId) {
        const inspector = document.getElementById('inspector-container');
        const inspectorContent = document.getElementById('inspector-content');
        const nodeIdElement = document.getElementById('inspector-node-id');
        const data = nodeData[nodeId];

        const nodeName = nodeNames[nodeId];
        nodeIdElement.textContent = `Node: ${nodeName != null ? nodeName : ""}`;
        inspectorContent.innerHTML = ''; // Clear previous content
        inspectorContent.appendChild(renderJsonTree(data, true));
        inspector.style.display = 'flex';

        currentNodeIndex = completedNodes.indexOf(nodeId);
        updateNavButtons();
    }

    function updateNavButtons() {
        document.getElementById('start-node').disabled = document.getElementById('prev-node').disabled = currentNodeIndex <= 0;
        document.getElementById('end-node').disabled = document.getElementById('next-node').disabled = currentNodeIndex >= completedNodes.length - 1;
    }

    document.getElementById('start-node').addEventListener('click', function() {
        if (currentNodeIndex > 0) {
            currentNodeIndex = 0;
            showInspector(completedNodes[currentNodeIndex]);
        }
    });


    document.getElementById('end-node').addEventListener('click', function() {
        if (currentNodeIndex < completedNodes.length - 1) {
            currentNodeIndex = completedNodes.length - 1;
            showInspector(completedNodes[currentNodeIndex]);
        }
    });

    document.getElementById('prev-node').addEventListener('click', function() {
        if (currentNodeIndex > 0) {
            currentNodeIndex--;
            showInspector(completedNodes[currentNodeIndex]);
        }
    });

    document.getElementById('next-node').addEventListener('click', function() {
        if (currentNodeIndex < completedNodes.length - 1) {
            currentNodeIndex++;
            showInspector(completedNodes[currentNodeIndex]);
        }
    });

    // View switcher logic
    const diagramViewBtn = document.getElementById('diagram-view-btn');
    const summaryViewBtn = document.getElementById('summary-view-btn');
    const diagramContent = document.getElementById('diagram-content');
    const summaryContent = document.getElementById('summary-content');

    diagramViewBtn.addEventListener('click', () => {
        if (diagramViewBtn.classList.contains('active')) return;
        diagramContent.style.display = 'block';
        summaryContent.style.display = 'none';
        diagramViewBtn.classList.add('active');
        summaryViewBtn.classList.remove('active');
    });

    summaryViewBtn.addEventListener('click', () => {
        if (summaryViewBtn.classList.contains('active')) return;
        summaryContent.innerHTML = marked.parse(workflowSummaryMarkdown);
        diagramContent.style.display = 'none';
        summaryContent.style.display = 'block';
        summaryViewBtn.classList.add('active');
        diagramViewBtn.classList.remove('active');
    });

    if (!workflowSummaryMarkdown || workflowSummaryMarkdown.trim() === '') {
        document.getElementById('view-switcher').style.display = 'none';
    }

    const graphDefinition = `{{graphDefinition}}`;

    const mermaidContainer = document.querySelector('.mermaid');
    mermaidContainer.textContent = graphDefinition;

    mermaid.initialize({
        startOnLoad: false,
        securityLevel: 'loose'
    });
    mermaid.run({
        nodes: [mermaidContainer]
    });

</script>
</body>
</html>